#########################################################################
# Title:         Nvidia: Nvidia Patch Task                              #
# Author(s):     desimaniac, l3uddz                                     #
# URL:           https://github.com/cloudbox/cloudbox                   #
# --                                                                    #
#         Part of the Cloudbox project: https://cloudbox.works          #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
# Nvidia Patch Tasks
# This file contains tasks for applying a patch to the Nvidia driver to remove
# the transcode limit on consumer-grade GPUs.

# Download the Nvidia patch script.
- name: Download Nvidia patch
  get_url:
    url:  "https://raw.githubusercontent.com/keylase/nvidia-patch/master/patch.sh"
    dest: /tmp/NVIDIA-patch.sh
    mode: 0775
    owner: root
    group: root
    force: yes
    validate_certs: no

# Run the Nvidia patch script.
- name: Install Nvidia patch
  shell: /tmp/NVIDIA-patch.sh
  args:
    executable: /bin/bash
    warn: no
  register: patch_install
  ignore_errors: yes

# Display a success message if the patch was installed successfully.
- name: Nvidia patch installed!
  debug:
    msg: "Nvidia patch installed!"
  when: (patch_install is succeeded) and ('Patched!' in patch_install.stdout)

# If the patch failed to install, fail the playbook.
- name: Nvidia patch did not install!
  fail:
    msg:
    - "Nvidia patch did not install!"
    - "{{ patch_install.stdout }}"
  when: (patch_install is failed) or ('Patched!' not in patch_install.stdout)